name: OTA Extract and Replace

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: 'URL hoáº·c Filename prefix - File gá»‘c Ä‘á»ƒ dump (tá»± Ä‘á»™ng phÃ¡t hiá»‡n)'
        required: true
        type: string
      source_file_2_path:
        description: 'File 2 path (URL hoáº·c Filename prefix) - Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng cáº§n'
        required: false
        type: string
      file_types:
        description: 'Loáº¡i file cáº§n thay (Ä‘á»ƒ trá»‘ng sáº½ tá»± Ä‘á»™ng detect tá»« config)'
        required: false
        type: string
      UPLOAD_TARGETS:
        description: 'Select which directories to upload.'
        required: true
        type: choice
        options:
          - organized
          - repacked
          - both
        default: 'repacked'

env:
  TZ: Asia/Ho_Chi_Minh

jobs:
  extract-and-replace:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: 'proplayer1131/FFF-Filer-Maker'
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./dump
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends aria2 uuid-dev liblz4-tool jq zip
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          python -m pip install --upgrade pip
          pip install httpx protobuf==6.32.0 bsdiff4 enlighten zstd brotli requests
          pip cache purge || true

      - name: Configure rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          if [ -z "${{ secrets.RCLONE_CONF2 }}" ]; then
            echo "âš ï¸  Warning: RCLONE_CONF2 secret chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh"
            touch ~/.config/rclone/rclone.conf
          else
            if echo "${{ secrets.RCLONE_CONF2 }}" | base64 -d > ~/.config/rclone/rclone.conf 2>/dev/null; then
              echo "âœ… Rclone configured tá»« secret"
            else
              echo "âŒ Lá»—i: KhÃ´ng thá»ƒ decode RCLONE_CONF2 secret"
              touch ~/.config/rclone/rclone.conf
            fi
          fi
          if [ -s ~/.config/rclone/rclone.conf ]; then
            echo "âœ… Rclone config file Ä‘Ã£ Ä‘Æ°á»£c táº¡o"
          else
            echo "âš ï¸  Rclone config file trá»‘ng - cáº§n cáº¥u hÃ¬nh thá»§ cÃ´ng"
          fi

      - name: Get ROM File
        id: get_rom
        run: |
          set -e
          FILE_PATH="${{ github.event.inputs.file_path }}"
          echo "::add-mask::${FILE_PATH}"
          if [[ "$FILE_PATH" == http://* ]] || [[ "$FILE_PATH" == https://* ]]; then
            echo "ðŸŒ Detected Direct URL. Downloading with aria2..."
            aria2c -x16 -s16 -j5 --file-allocation=none --summary-interval=10 -o rom.zip "$FILE_PATH"
          else
            echo "ðŸ” Detected Filename Prefix. Searching cloud..."
            FILE="$(rclone lsf '1drive1:Mirror' --files-only --include "${FILE_PATH}*" | head -n1)"
            if [ -n "$FILE" ]; then
              echo "âœ… Found in OneDrive: $FILE"
              SOURCE_PATH="1drive1:Mirror"
            else
              FILE="$(rclone lsf 'gdrive1:VS_Stock' --files-only --include "${FILE_PATH}*" | head -n1)"
              if [ -n "$FILE" ]; then
                echo "âœ… Found in GDrive: $FILE"
                SOURCE_PATH="gdrive1:VS_Stock"
              fi
            fi
            if [ -z "$FILE" ]; then
              echo "::error::File not found in OneDrive or GDrive!"
              exit 1
            fi
            DIRECT_URL=$(rclone link "$SOURCE_PATH/$FILE" 2>/dev/null || true)
            if [ -n "$DIRECT_URL" ]; then
              echo "::add-mask::$DIRECT_URL"
              echo "ðŸš€ Direct link generated! Downloading with aria2..."
              if aria2c -x16 -s16 -j5 --file-allocation=none --summary-interval=10 -o rom.zip "$DIRECT_URL" 2>&1; then
                if [ ! -f rom.zip ] || [ ! -s rom.zip ]; then
                  echo "âš ï¸  aria2c download failed or file is empty, falling back to rclone copy..."
                  rm -f rom.zip
                  rclone copyto "$SOURCE_PATH/$FILE" ./rom.zip \
                    --transfers=4 --checkers=8 --multi-thread-streams=16 \
                    --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                    --progress --stats 10s
                fi
              else
                echo "âš ï¸  aria2c download failed, falling back to rclone copy..."
                rm -f rom.zip
                rclone copyto "$SOURCE_PATH/$FILE" ./rom.zip \
                  --transfers=4 --checkers=8 --multi-thread-streams=16 \
                  --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                  --progress --stats 10s
              fi
            else
              echo "âš ï¸  No direct link. Falling back to rclone copy..."
              rclone copyto "$SOURCE_PATH/$FILE" ./rom.zip \
                --transfers=4 --checkers=8 --multi-thread-streams=16 \
                --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                --progress --stats 10s
            fi
          fi
          
          if [ ! -f rom.zip ]; then
            echo "::error::rom.zip was not created. Check source and path."
            exit 1
          fi
          
          FILE_SIZE=$(du -h rom.zip | cut -f1)
          echo "âœ… File rom.zip is ready (Size: ${FILE_SIZE})"

      - name: Get Source File 2 (for ODM/REGION/OPLUSTANVBK)
        id: get_file_2
        if: github.event.inputs.source_file_2_path != ''
        run: |
          set -e
          FILE_PATH_2="${{ github.event.inputs.source_file_2_path }}"
          
          echo "ðŸ“‹ File 2 config:"
          echo "   Path: [MASKED]"
          echo "::add-mask::${FILE_PATH_2}"
          echo "â³ Äá»£i 10 giÃ¢y trÆ°á»›c khi táº£i file 2..."
          sleep 10
          if [[ "$FILE_PATH_2" == http://* ]] || [[ "$FILE_PATH_2" == https://* ]]; then
            echo "ðŸŒ Detected Direct URL for file 2..."
            if [[ "$FILE_PATH_2" == *"sharepoint.com"* ]] || [[ "$FILE_PATH_2" == *"sharepoint"* ]]; then
              echo "ðŸ” PhÃ¡t hiá»‡n SharePoint URL - sá»­ dá»¥ng cháº¿ Ä‘á»™ Ä‘áº·c biá»‡t"
              MAX_RETRIES=5
              RETRY_COUNT=0
              DOWNLOAD_SUCCESS=false
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                echo "ðŸ”„ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES (SharePoint mode)..."
                
                if curl -L --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
                    --retry 2 --retry-delay 10 --max-time 3600 \
                    -o source_file_2.zip "$FILE_PATH_2" 2>&1; then
                  if [ -f source_file_2.zip ] && [ -s source_file_2.zip ]; then
                    DOWNLOAD_SUCCESS=true
                    break
                  fi
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  WAIT_TIME=$((30 * (2 ** (RETRY_COUNT - 1))))
                  echo "âš ï¸  Download failed, Ä‘á»£i ${WAIT_TIME} giÃ¢y trÆ°á»›c khi retry..."
                  sleep ${WAIT_TIME}
                  rm -f source_file_2.zip
                fi
              done
              
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                echo "âŒ KhÃ´ng thá»ƒ táº£i file 2 sau $MAX_RETRIES láº§n thá»­"
              fi
            else
              echo "ðŸ“¥ Downloading file 2 from URL with aria2..."
              aria2c -x8 -s8 -j3 --file-allocation=none --summary-interval=10 \
                  --max-tries=3 --retry-wait=10 \
                  -o source_file_2.zip "$FILE_PATH_2"
            fi
          else
            echo "ðŸ” Detected Filename Prefix. Searching cloud for file 2..."
            FILE="$(rclone lsf '1drive1:Mirror' --files-only --include "${FILE_PATH_2}*" | head -n1)"
            if [ -n "$FILE" ]; then
              echo "âœ… Found in OneDrive: $FILE"
              SOURCE_PATH="1drive1:Mirror"
            else
              FILE="$(rclone lsf 'gdrive1:VS_Stock' --files-only --include "${FILE_PATH_2}*" | head -n1)"
              if [ -n "$FILE" ]; then
                echo "âœ… Found in GDrive: $FILE"
                SOURCE_PATH="gdrive1:VS_Stock"
              fi
            fi
            if [ -z "$FILE" ]; then
              echo "âš ï¸  File 2 not found in OneDrive or GDrive, skipping..."
              echo "file_2_ready=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            DIRECT_URL=$(rclone link "$SOURCE_PATH/$FILE" 2>/dev/null || true)
            if [ -n "$DIRECT_URL" ]; then
              echo "::add-mask::$DIRECT_URL"
              echo "ðŸš€ Direct link generated! Downloading with aria2..."
              if aria2c -x8 -s8 -j3 --file-allocation=none --summary-interval=10 \
                  --max-tries=3 --retry-wait=10 \
                  -o source_file_2.zip "$DIRECT_URL" 2>&1; then
                if [ ! -f source_file_2.zip ] || [ ! -s source_file_2.zip ]; then
                  echo "âš ï¸  aria2c download failed or file is empty, falling back to rclone copy..."
                  rm -f source_file_2.zip
                  rclone copyto "$SOURCE_PATH/$FILE" ./source_file_2.zip \
                    --transfers=4 --checkers=8 --multi-thread-streams=16 \
                    --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                    --progress --stats 10s || true
                fi
              else
                echo "âš ï¸  aria2c download failed, falling back to rclone copy..."
                rm -f source_file_2.zip
                rclone copyto "$SOURCE_PATH/$FILE" ./source_file_2.zip \
                  --transfers=4 --checkers=8 --multi-thread-streams=16 \
                  --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                  --progress --stats 10s || true
              fi
            else
              echo "âš ï¸  No direct link. Falling back to rclone copy..."
              rclone copyto "$SOURCE_PATH/$FILE" ./source_file_2.zip \
                --transfers=4 --checkers=8 --multi-thread-streams=16 \
                --buffer-size=64M --onedrive-chunk-size=256M --drive-chunk-size=256M \
                --progress --stats 10s || true
            fi
          fi
          
          if [ -f source_file_2.zip ] && [ -s source_file_2.zip ]; then
            FILE_SIZE=$(du -h source_file_2.zip | cut -f1)
            echo "âœ… File 2 is ready: source_file_2.zip (Size: ${FILE_SIZE})"
            echo "file_2_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ File 2 was not created or is empty"
            echo "   âš ï¸  Workflow sáº½ tiáº¿p tá»¥c vÃ  sá»­ dá»¥ng OneDrive fallback náº¿u cáº§n"
            echo "file_2_ready=false" >> $GITHUB_OUTPUT
            rm -f source_file_2.zip
          fi

      - name: Extract payload info
        id: payload_info
        working-directory: ./dump
        run: |
          python get_payload_info.py ../rom.zip -o payload_info.json || \
          python get_payload_info.py ../rom.zip
          
          if [ -f payload_info.json ]; then
            VERSION=$(python -c "import json; print(json.load(open('payload_info.json')).get('version_name', 'unknown'))")
            PRODUCT=$(python -c "import json; print(json.load(open('payload_info.json')).get('product_name', 'unknown'))")
            DEVICE_CODE=$(python -c "import json; d=json.load(open('payload_info.json')); print(d.get('device_code', d.get('product_name', 'unknown')))")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "product=$PRODUCT" >> $GITHUB_OUTPUT
            echo "device_code=$DEVICE_CODE" >> $GITHUB_OUTPUT
            echo "âœ… Version: $VERSION"
            echo "âœ… Product: $PRODUCT"
            echo "âœ… Device Code: $DEVICE_CODE"
          else
            echo "âš ï¸  KhÃ´ng thá»ƒ láº¥y thÃ´ng tin version"
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "product=unknown" >> $GITHUB_OUTPUT
            echo "device_code=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Extract payload
        working-directory: ./dump
        run: |
          echo "ðŸš€ Báº¯t Ä‘áº§u giáº£i nÃ©n payload file gá»‘c..."
          python extract_payload.py ../rom.zip --out output --organized organized
          echo "âœ… ÄÃ£ extract payload file gá»‘c xong"
          if [ -d output ]; then
            rm -rf output
            echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a thÆ° má»¥c output táº¡m"
          fi
          if [ -f payload_info.json ]; then
            rm -f payload_info.json
            echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a payload_info.json táº¡m"
          fi

      - name: Extract partitions from File 2
        id: extract_file_2
        if: steps.get_file_2.outputs.file_2_ready == 'true'
        working-directory: ./dump
        run: |
          echo "ðŸ’¾ Kiá»ƒm tra dung lÆ°á»£ng Ä‘Ä©a trÆ°á»›c khi dump file 2..."
          df -h . | head -2
          echo "ðŸ“¦ Äang dump file 2 Ä‘á»ƒ láº¥y ODM/REGION/OPLUSTANVBK..."
          python extract_payload.py ../source_file_2.zip --out output_file_2 --organized organized_file_2
          echo "âœ… ÄÃ£ dump file 2"
          if [ -f ../source_file_2.zip ]; then
            rm -f ../source_file_2.zip
            echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a source_file_2.zip"
          fi
          echo "file_2_extracted=true" >> $GITHUB_OUTPUT
          if [ -d output_file_2 ]; then
            rm -rf output_file_2
            echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a thÆ° má»¥c output_file_2 táº¡m"
          fi

      - name: Copy partitions from File 2 to File 1
        id: copy_partitions
        if: steps.extract_file_2.outputs.file_2_extracted == 'true'
        working-directory: ./dump
        env:
          DEVICE_CODE: ${{ steps.payload_info.outputs.device_code }}
          VERSION: ${{ steps.payload_info.outputs.version }}
          FILE_TYPES: ${{ github.event.inputs.file_types }}
        run: |
          python3 copy_partitions_from_file2.py 2>&1 | tee copy_output.txt
          FILE_TYPES_REPLACED=$(grep "FILE_TYPES_REPLACED=" copy_output.txt 2>/dev/null | tail -1 | cut -d'=' -f2)
          if [ ! -z "$FILE_TYPES_REPLACED" ]; then
            echo "file_types_replaced=$FILE_TYPES_REPLACED" >> $GITHUB_OUTPUT
            echo "âœ… File types Ä‘Ã£ copy: $FILE_TYPES_REPLACED"
          else
            # Fallback: sá»­ dá»¥ng FILE_TYPES tá»« env
            if [ ! -z "$FILE_TYPES" ]; then
              echo "file_types_replaced=$FILE_TYPES" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Replace files from OneDrive (fallback)
        id: replace_files
        if: steps.copy_partitions.outputs.file_types_replaced == '' || steps.extract_file_2.outputs.file_2_extracted != 'true'
        working-directory: ./dump
        env:
          DEVICE_CODE: ${{ steps.payload_info.outputs.device_code }}
          VERSION: ${{ steps.payload_info.outputs.version }}
          FILE_TYPES: ${{ github.event.inputs.file_types }}
        run: |
          if [ "${{ steps.extract_file_2.outputs.file_2_extracted }}" != "true" ]; then
            echo "ðŸ”„ Táº£i file tá»« OneDrive (khÃ´ng cÃ³ file 2)..."
            if [ -z "$FILE_TYPES" ]; then
              echo "ðŸ”„ Tá»± Ä‘á»™ng detect file types tá»« config..."
              python replace_multiple_files.py \
                --organized-dir organized \
                --device-code "$DEVICE_CODE" \
                --version "$VERSION" > replace_output.txt 2>&1 || true
            else
              echo "ðŸ”„ Sá»­ dá»¥ng file types Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh: $FILE_TYPES"
              python replace_multiple_files.py \
                --organized-dir organized \
                --device-code "$DEVICE_CODE" \
                --version "$VERSION" \
                --file-types "$FILE_TYPES" > replace_output.txt 2>&1 || true
            fi
            if [ -f replace_output.txt ]; then
              REPLACED_TYPES=$(grep -oE "(ODM|REGION|OPLUSTANVBK)" replace_output.txt | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ ! -z "$REPLACED_TYPES" ]; then
                echo "file_types_replaced=$REPLACED_TYPES" >> $GITHUB_OUTPUT
                echo "âœ… File types Ä‘Ã£ thay: $REPLACED_TYPES"
              fi
            fi
          else
            echo "â­ï¸  ÄÃ£ copy tá»« file 2, bá» qua OneDrive"
            if [ ! -z "${{ steps.copy_partitions.outputs.file_types_replaced }}" ]; then
              echo "file_types_replaced=${{ steps.copy_partitions.outputs.file_types_replaced }}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Show organized directory structure
        working-directory: ./dump
        run: |
          echo ""
          echo "ðŸ“ Cáº¥u trÃºc thÆ° má»¥c organized:"
          echo "============================================================"
          if [ -d organized ]; then
            for dir in SYSTEM BOOTLOADER CRITICAL MODEM EXTRA; do
              if [ -d "organized/$dir" ]; then
                echo ""
                echo "ðŸ“‚ organized/$dir/"
                echo "----------------------------------------"
                ls -lh "organized/$dir/" | tail -n +2 | awk '{printf "  %-40s %8s\n", $9, $5}'
                FILE_COUNT=$(find "organized/$dir" -type f | wc -l)
                TOTAL_SIZE=$(du -sh "organized/$dir" | cut -f1)
                echo "  â†’ Tá»•ng: $FILE_COUNT files, Size: $TOTAL_SIZE"
              fi
            done
            echo ""
            echo "ðŸ“Š Tá»•ng quan thÆ° má»¥c organized:"
            echo "----------------------------------------"
            du -sh organized/*/ 2>/dev/null | awk '{printf "  %-20s %s\n", $2, $1}'
            TOTAL_FILES=$(find organized -type f | wc -l)
            TOTAL_SIZE=$(du -sh organized | cut -f1)
            echo "  â†’ Tá»•ng cá»™ng: $TOTAL_FILES files, Total Size: $TOTAL_SIZE"
          else
            echo "âš ï¸  ThÆ° má»¥c organized khÃ´ng tá»“n táº¡i"
          fi
          echo "============================================================"

      - name: Repack payload
        id: repack
        working-directory: ./dump
        run: |
          PRODUCT="${{ steps.payload_info.outputs.product }}"
          VERSION="${{ steps.payload_info.outputs.version }}"
          REPLACED_TYPES="${{ steps.replace_files.outputs.file_types_replaced }}"
          OUTPUT_NAME="${PRODUCT}-ota_full-OS${VERSION}"
          if [ ! -z "$REPLACED_TYPES" ]; then
            OUTPUT_NAME="${OUTPUT_NAME}_${REPLACED_TYPES}"
          fi
          OUTPUT_NAME="${OUTPUT_NAME}.zip"
          echo "ðŸ“¦ Äang Ä‘Ã³ng gÃ³i láº¡i payload..."
          python repack_payload.py \
            --original-zip ../rom.zip \
            --organized-dir organized \
            --output "$OUTPUT_NAME" \
            --file-types "$REPLACED_TYPES"
          if [ -f "$OUTPUT_NAME" ]; then
            echo "output_file=$OUTPUT_NAME" >> $GITHUB_OUTPUT
            echo "âœ… ÄÃ£ táº¡o file: $OUTPUT_NAME"
            echo ""
            echo "ðŸ“ Danh sÃ¡ch files trong thÆ° má»¥c dump:"
            echo "============================================================"
            ls -lh *.zip 2>/dev/null || echo "KhÃ´ng cÃ³ file .zip nÃ o"
            echo ""
            echo "ðŸ“Š Chi tiáº¿t file output:"
            ls -lh "$OUTPUT_NAME"
            echo ""
            echo "ðŸ“¦ Ná»™i dung bÃªn trong file zip:"
            echo "============================================================"
            unzip -l "$OUTPUT_NAME" | head -50
            echo ""
            echo "ðŸ“‚ Cáº¥u trÃºc thÆ° má»¥c trong zip:"
            echo "============================================================"
            unzip -l "$OUTPUT_NAME" | grep -E "^[ ]*[0-9]+.*/$" | head -20 || echo "KhÃ´ng cÃ³ thÆ° má»¥c"
            echo ""
            echo "ðŸ“„ Tá»•ng sá»‘ files vÃ  thÆ° má»¥c:"
            unzip -l "$OUTPUT_NAME" | tail -1
            echo "============================================================"
            if [ -f ../rom.zip ]; then
              rm -f ../rom.zip
              echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a rom.zip"
            fi
            if [ -d organized_file_2 ]; then
              rm -rf organized_file_2
              echo "ðŸ—‘ï¸  ÄÃ£ xÃ³a thÆ° má»¥c organized_file_2"
            fi
          else
            echo "âŒ KhÃ´ng thá»ƒ táº¡o file output"
            exit 1
          fi

      - name: Set Upload Folder Name
        id: set_folder
        run: |
          OUTPUT_FILE="${{ steps.repack.outputs.output_file }}"
          
          if [ -z "$OUTPUT_FILE" ]; then
            echo "::error::TÃªn file output bá»‹ trá»‘ng. Dá»«ng láº¡i."
            exit 1
          fi

          FOLDER_NAME="${OUTPUT_FILE%.zip}"

          echo "UPLOAD_FOLDER_NAME=$FOLDER_NAME" >> $GITHUB_ENV
          echo "âœ… Final Upload Folder Name: $FOLDER_NAME"
      
      - name: Upload Dumps and Generate Link
        env:
          RCLONE_DEST: "1drive1:OTA_DUMPS"
        run: |
          INCLUDE_FLAGS=""
          if [[ "${{ github.event.inputs.UPLOAD_TARGETS }}" == "organized" ]]; then
            INCLUDE_FLAGS="--include /dump/organized/**"
          elif [[ "${{ github.event.inputs.UPLOAD_TARGETS }}" == "repacked" ]]; then
            INCLUDE_FLAGS="--include /dump/*.zip"
          elif [[ "${{ github.event.inputs.UPLOAD_TARGETS }}" == "both" ]]; then
            INCLUDE_FLAGS="--include /dump/organized/** --include /dump/*.zip"
          fi
          
          FULL_REMOTE_PATH="${RCLONE_DEST}/${UPLOAD_FOLDER_NAME}"
          echo "::add-mask::${RCLONE_DEST}"
          echo "::add-mask::${FULL_REMOTE_PATH}"
          echo "Preparing to upload..."
          rclone copy ./dump "${FULL_REMOTE_PATH}" \
              $INCLUDE_FLAGS \
              --transfers=16 \
              --checkers=32 \
              --log-level NOTICE \
              --stats-one-line \
              --stats 30s
          
          echo "Verifying upload..."
          FILE_COUNT=$(rclone lsf --max-depth 2 "${FULL_REMOTE_PATH}" | wc -l)
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "âœ… Upload confirmed."
            UPLOAD_SIZE=$(rclone size --json --copy-links "${FULL_REMOTE_PATH}" | jq -r '.bytes' | awk '{ sum=$1 ; hum[1024**3]="GB";hum[1024**2]="MB";hum[1024]="KB"; for (x=1024**3; x>=1024; x/=1024){ if (sum>=x) { printf "%.2f %s\n",sum/x,hum[x];break } }}')
            UPLOAD_LINK=$(rclone link "${FULL_REMOTE_PATH}")
            if [ -z "${UPLOAD_LINK}" ]; then UPLOAD_LINK="KhÃ´ng thá»ƒ táº¡o link."; fi
          else
            echo "âŒ Error: Upload verification failed."
            UPLOAD_SIZE="N/A"
            UPLOAD_LINK="Táº£i lÃªn tháº¥t báº¡i."
          fi
          echo "::add-mask::${UPLOAD_LINK}"
          echo "BOT_OUTPUT::TÃªn thÆ° má»¥c=${UPLOAD_FOLDER_NAME}"
          echo "BOT_OUTPUT::KÃ­ch thÆ°á»›c=${UPLOAD_SIZE:-N/A}"
          echo "BOT_OUTPUT::Link Táº£i=${UPLOAD_LINK}"

      - name: Create summary
        run: |
          echo "## ðŸ“¦ Káº¿t quáº£ giáº£i nÃ©n vÃ  thay tháº¿ payload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Product Name:** ${{ steps.payload_info.outputs.product }}" >> $GITHUB_STEP_SUMMARY
          echo "**Device Code:** ${{ steps.payload_info.outputs.device_code }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.payload_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**File Types Replaced:** ${{ steps.replace_files.outputs.file_types_replaced || steps.copy_partitions.outputs.file_types_replaced }}" >> $GITHUB_STEP_SUMMARY
          echo "**Output File:** ${{ steps.repack.outputs.output_file }}" >> $GITHUB_STEP_SUMMARY

    
