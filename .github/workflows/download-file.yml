name: DL OTA FILE 

on:
  workflow_dispatch:
    inputs:
      DOWNLOAD_URL:
        description: 'Direct Download Link (to .zip file)'
        required: true
      TEMP_FILE_NAME:
        description: 'Temporary/Default name (e.g., download.zip)'
        required: true
        default: 'download.zip'
      ONEDRIVE_REMOTE:
        description: 'Your rclone remote name'
        required: true
        default: '1drive'
      ONEDRIVE_PATH:
        description: 'Folder path on OneDrive'
        required: true
        default: 'Mirror'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      message_id: ${{ steps.send_initial.outputs.message_id }}
      final_name: ${{ steps.parse.outputs.final_name }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Tools (Absolute Path Fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip aria2
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          
          sudo cp rclone /usr/local/bin/
          sudo chown root:root /usr/local/bin/rclone
          sudo chmod 755 /usr/local/bin/rclone
          
          sudo ln -sf /usr/local/bin/rclone /usr/bin/rclone
          
          /usr/local/bin/rclone version

      - name: Configure rclone
        env:
          RCLONE_CONF_BASE64: ${{ secrets.RCLONE_CONF_BASE64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF_BASE64" | base64 -d > ~/.config/rclone/rclone.conf

      - name: Mask Remote Info in Logs
        run: |
          echo "::add-mask::${{ inputs.ONEDRIVE_REMOTE }}"
          echo "::add-mask::${{ inputs.ONEDRIVE_PATH }}"

      - name: Download, Parse Name, and Rename
        id: parse
        run: |
          echo "Starting accelerated download as ${{ inputs.TEMP_FILE_NAME }}..."
          aria2c -x 16 -s 16 -o "${{ inputs.TEMP_FILE_NAME }}" "${{ inputs.DOWNLOAD_URL }}"
          
          echo "Attempting to extract and parse metadata..."
          if unzip -l "${{ inputs.TEMP_FILE_NAME }}" | grep -q "META-INF/com/android/metadata"; then
              unzip -p "${{ inputs.TEMP_FILE_NAME }}" META-INF/com/android/metadata 2>/dev/null | grep 'version_name_show=' > metadata_line.txt
          else
              echo "Metadata file not found inside zip."
              echo "" > metadata_line.txt
          fi
          
          if [ -s metadata_line.txt ]; then
              BASE_NAME=$(cat metadata_line.txt | sed -n 's/version_name_show=\(.*\)(.*)/\1/p')
          else
              BASE_NAME=""
          fi
          
          PREFIX=""
          if [ -n "$BASE_NAME" ]; then
              FINAL_NAME="${BASE_NAME}.zip"
              echo "Successfully parsed name. Renaming to: $FINAL_NAME"
              mv "${{ inputs.TEMP_FILE_NAME }}" "$FINAL_NAME"
              PREFIX=$(echo "$FINAL_NAME" | awk -F'_' '{print $1}')_
          else
              FINAL_NAME="${{ inputs.TEMP_FILE_NAME }}"
              echo "Warning: Could not parse metadata. Using default name: $FINAL_NAME"
          fi
          
          echo "final_name=$FINAL_NAME" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      - name: Send Initial Telegram Message
        id: send_initial
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            Processing file:
            `${{ steps.parse.outputs.final_name }}`
          format: markdown

      - name: Check if File Already Exists
        id: check_duplicate
        env:
          REMOTE: ${{ inputs.ONEDRIVE_REMOTE }}
          PATH: ${{ inputs.ONEDRIVE_PATH }}
          FILENAME: ${{ steps.parse.outputs.final_name }}
        run: |
          RCLONE="/usr/local/bin/rclone"
          
          echo "Checking for exact duplicate: $FILENAME in $REMOTE:$PATH"
          
          if ! "$RCLONE" version > /dev/null 2>&1; then
             echo "CRITICAL ERROR: Cannot execute rclone at $RCLONE"
             exit 1
          fi

          if DUPLICATE_CHECK=$("$RCLONE" lsf "$REMOTE:$PATH" --files-only --include "$FILENAME"); then
              echo "List command successful."
          else
              echo "ERROR: Failed to list files on remote. Check configuration."
              exit 1
          fi
          
          DUPLICATE_CHECK=$(echo "$DUPLICATE_CHECK" | xargs)

          if [[ -n "$DUPLICATE_CHECK" ]]; then
            echo "‚ùå DETECTED DUPLICATE: $DUPLICATE_CHECK"
            echo "Aborting process..."
            
            MSG_ID="${{ steps.send_initial.outputs.message_id }}"
            if [[ -n "$MSG_ID" ]]; then
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/editMessageText" \
                -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -d "message_id=$MSG_ID" \
                -d "text=‚õî **Upload Aborted!**%0A%0AFile \`$FILENAME\` already exists in Destination." \
                -d "parse_mode=Markdown"
            fi
            exit 1
          else
            echo "‚úÖ No duplicate found. Proceeding."
          fi

      - name: Check and Move Old Versions
        id: check_move
        if: steps.parse.outputs.prefix != ''
        env:
          REMOTE: ${{ inputs.ONEDRIVE_REMOTE }}
          PATH: ${{ inputs.ONEDRIVE_PATH }}
          PREFIX: ${{ steps.parse.outputs.prefix }}
          CURRENT_FILE: ${{ steps.parse.outputs.final_name }}
        run: |
          RCLONE="/usr/local/bin/rclone"
          
          echo "Scanning for existing files with prefix: $PREFIX"
          
          EXISTING_FILES=$("$RCLONE" lsf "$REMOTE:$PATH" --files-only --include "${PREFIX}*" || true)
          
          if [[ -n "$EXISTING_FILES" ]]; then
            echo "‚ö†Ô∏è Found potential old versions. Processing..."
            
            MSG_ID="${{ steps.send_initial.outputs.message_id }}"
            if [[ -n "$MSG_ID" ]]; then
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/editMessageText" \
                -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -d "message_id=$MSG_ID" \
                -d "text=Found old version(s). Moving to OLD folder..." \
                -d "parse_mode=Markdown"
            fi

            echo "$EXISTING_FILES" | while IFS= read -r FILE; do
                if [[ -z "$FILE" ]]; then continue; fi
                
                if [[ "$FILE" == "$CURRENT_FILE" ]]; then 
                    echo "Skipping current file: $FILE"
                    continue 
                fi
                
                echo "üöÄ Moving '$FILE' to '$PATH/OLD/'..."
                "$RCLONE" move "$REMOTE:$PATH/$FILE" "$REMOTE:$PATH/OLD/" --verbose
            done
            
            echo "‚úÖ Move complete."
          else
            echo "‚úÖ No old versions found. Clean upload."
          fi

      - name: Upload and Update Message
        id: upload
        run: |
          RCLONE="/usr/local/bin/rclone"
          
          echo "Updating Telegram message to 'Uploading'..."
          MSG_ID="${{ steps.send_initial.outputs.message_id }}"
          
          if [ -n "$MSG_ID" ]; then
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/editMessageText" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "message_id=$MSG_ID" \
              -d "text=Uploading: \`${{ steps.parse.outputs.final_name }}\`" \
              -d "parse_mode=Markdown"
          fi
          
          echo "Uploading to rclone remote"
          "$RCLONE" copy "${{ steps.parse.outputs.final_name }}" "${{ inputs.ONEDRIVE_REMOTE }}:${{ inputs.ONEDRIVE_PATH }}" \
            --multi-thread-streams=16 \
            --multi-thread-cutoff=16M \
            --stats=10s

      - name: Send Success Notification
        if: success()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ‚úÖ Upload Successful!
            
            File: `${{ steps.parse.outputs.final_name }}`
            Destination: `${{ inputs.ONEDRIVE_REMOTE }}:${{ inputs.ONEDRIVE_PATH }}`
          format: markdown

  notify_failure:
    runs-on: ubuntu-latest
    needs: build
    if: always() && needs.build.result == 'failure'
    steps:
      - name: Send Failure Notification
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ‚ùå Upload FAILED / ABORTED!
            
            Reason: Error occurred or Duplicate file detected.
          format: markdown
