name: test-zz

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Select device code OR Select Custom'
        required: true
        default: 'PKG110'
        type: choice 
        options:
          - PLK110
          - PLQ110
          - PJZ110
          - PKX110
          - PKG110
          - PKR110
          - PJE110
          - PJX110
          - PJF110
          - PJD110
          - OPD2413
          - OPD2404
          - RMX6699
          - RMX5200
          - RMX5010
          - RMX5090
          - RMX3800
          - RMX3888
          - PHY110
          - Custom
      
      CUSTOM_URL:
        description: 'Custom (If selected above)'
        required: false
        default: ''

env:
  TZ: Asia/Ho_Chi_Minh

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    steps:
      - name: Clean 1
        run: |
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
          sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo apt -y autoremove --purge || true
          sudo apt -y autoclean || true
          sudo apt clean || true
      
      - name: Clean 2
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 8192 
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
      
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install System & Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo apt-get install -y --no-install-recommends \
            aria2 rclone zip unzip p7zip-full python3-pip \
            liblz4-tool zstd xmlstarlet bc file git \
            build-essential autoconf libtool pkg-config uuid-dev liblz4-dev libselinux1-dev \
            zlib1g-dev \
            android-sdk-libsparse-utils
            
      - name: Process Super Domestic
        env:
            RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          
          mkdir -p tmp
          export TMPDIR=$(pwd)/tmp
          export XDG_CACHE_HOME=$(pwd)/tmp
          export RCLONE_CACHE_DIR=$(pwd)/tmp
          echo "üìÇ Custom TMPDIR & Cache set to: $TMPDIR"
          
          echo "üîß Setting up Rclone config..."
          echo "$RCLONE_CONF" > rclone.conf
          
          echo "üëÄ Listing available remotes in config:"
          rclone --config rclone.conf listremotes
          echo "-----------------------------------"

          echo "üß™ Checking Write Access on '1drive'..."
          echo "Test write access at $(date)" > test_write.txt
          if rclone --config rclone.conf copy test_write.txt "1drive:/Mirror/Domestic/"; then
              echo "‚úÖ Write Check Passed: Account is active and writable."
              rclone --config rclone.conf delete "1drive:/Mirror/Domestic/test_write.txt" || true
          else
              echo "‚ùå Write Check FAILED! Your OneDrive account is Read-Only or Locked."
              exit 1
          fi
          
          OPTION="${{ github.event.inputs.ROM_URL }}"
          CUSTOM="${{ github.event.inputs.CUSTOM_URL }}"
          
          if [ "$OPTION" == "Custom" ]; then
            if [ -z "$CUSTOM" ]; then
              echo "‚ùå Error: Custom selected but empty URL!"
              exit 1
            fi
            INPUT="$CUSTOM"
          else
            INPUT="$OPTION"
          fi

          echo "üéØ Target: $INPUT"

          echo "üîç Searching in OneDrive: Mirror/Domestic..."
          FILE="$(rclone --config rclone.conf lsf '1drive:/Mirror/Domestic' --files-only --include "${INPUT}*" | head -n1)"
          
          if [ -n "$FILE" ]; then
            echo "‚úÖ Found in OneDrive Domestic: $FILE"
            SOURCE_PATH="1drive:/Mirror/Domestic"
          else
            echo "‚ùå Error: File not found in Mirror/Domestic (1drive)!"
            exit 1
          fi

          echo "üîó Generating Direct Link..."
          DIRECT_URL=$(rclone --config rclone.conf link "$SOURCE_PATH/$FILE")
          
          if [ -n "$DIRECT_URL" ]; then
             echo "::add-mask::$DIRECT_URL"
             echo "üåê Link generated: $DIRECT_URL"
             
             echo "‚¨áÔ∏è Downloading $FILE with aria2..."
             aria2c -x16 -s16 -k1M --check-certificate=false -o "$FILE" "$DIRECT_URL"
          else
             echo "‚ùå Error: Could not generate direct link. Falling back to rclone copy..."
             rclone --config rclone.conf copy "$SOURCE_PATH/$FILE" . --transfers=8 --checkers=16 --progress
          fi

          echo "üì¶ Unzipping ROM..."
          mkdir -p rom_extracted
          unzip -q "$FILE" -d rom_extracted
          rm "$FILE"

          echo "üìã Listing ALL extracted directories (Depth 3) for debugging:"
          find rom_extracted -maxdepth 3 -type d -not -path '*/.*'
          echo "----------------------------------------"

          echo "üïµÔ∏è Deep searching for 'IMAGES' folder..."
          DETECTED_IMAGES=$(find rom_extracted -type d -name "IMAGES" | head -n 1)
          
          if [ -n "$DETECTED_IMAGES" ]; then
            echo "‚úÖ Found IMAGES folder at: $DETECTED_IMAGES"
            REAL_ROOT=$(dirname "$DETECTED_IMAGES")
            
            if [ "$REAL_ROOT" != "rom_extracted" ]; then
              echo "‚ö†Ô∏è Nested structure detected at: $REAL_ROOT"
              echo "üîÑ Bringing everything to root..."
              
              mkdir -p ../temp_move_root
              mv "$REAL_ROOT"/* ../temp_move_root/
              rm -rf rom_extracted/*
              mv ../temp_move_root/* rom_extracted/
              rmdir ../temp_move_root
              echo "‚úÖ Structure normalized."
            else
              echo "‚úÖ Structure is already flat (root/IMAGES)."
            fi
          else
            echo "‚ùå Error: 'IMAGES' folder NOT found anywhere in the zip!"
            
            if [ -f "rom_extracted/payload.bin" ]; then
                echo "‚ö†Ô∏è WARNING: Found 'payload.bin'. This is an OTA ROM."
                echo "‚ö†Ô∏è You need to extract payload.bin first or use a Decrypted ROM."
            fi
          fi

          echo "üìÇ Checking structure..."
          if [ -d "rom_extracted/IMAGES" ] && [ -d "rom_extracted/SYSTEM" ] && [ -d "rom_extracted/RADIO" ]; then
              echo "‚úÖ Valid Structure: IMAGES, SYSTEM, RADIO found."
          else
              echo "‚ö†Ô∏è Warning: Standard folders missing. Listing root content:"
              ls -F rom_extracted/
          fi

          echo "‚¨áÔ∏è Cloning build-super-domestic (Private Repo)..."
          git clone https://${{ secrets.ACTION_TOKEN }}@github.com/proplayer1131/build-super-domestic tools_repo

          echo "üõ†Ô∏è Merging tool into extracted ROM..."
          cp -rf tools_repo/* rom_extracted/
          rm -rf rom_extracted/.git

          echo "üîë Granting execute permissions..."
          sudo chmod -R 777 rom_extracted/
          
          echo "‚öôÔ∏è Running create_super_img.sh..."
          cd rom_extracted
          
          if [ -f "create_super_img.sh" ]; then
            sudo TMPDIR="$TMPDIR" ./create_super_img.sh
          else
            echo "‚ùå Error: create_super_img.sh not found inside rom_extracted!"
            ls -F
            exit 1
          fi
          
          cd ..

          TARGET_IMG="rom_extracted/IMAGES/super.img"
          DIR_NAME="${FILE%.*}" 
          DEST_PATH="1drive:/Mirror/Domestic/Super/$DIR_NAME"

          echo "TARGET_IMG=$TARGET_IMG" >> $GITHUB_ENV
          echo "DEST_PATH=$DEST_PATH" >> $GITHUB_ENV
          
          echo "‚úÖ Build completed. Proceeding to upload..."

      - name: Upload Result
        run: |
          echo "üöÄ Checking for output file: $TARGET_IMG"
          
          if [ -f "$TARGET_IMG" ]; then
              echo "‚úÖ File found! Uploading ONLY super.img..."
              echo "‚û°Ô∏è Destination: $DEST_PATH/super.img"
              echo "‚ÑπÔ∏è Logging progress every 10 seconds..."
              
              export XDG_CACHE_HOME=$(pwd)/tmp
              export RCLONE_CACHE_DIR=$(pwd)/tmp
              
              rclone --config rclone.conf copy "$TARGET_IMG" "$DEST_PATH" \
                --transfers=8 --checkers=16 \
                -v --stats 10s --stats-one-line
          else
              echo "‚ùå Error: super.img NOT found at $TARGET_IMG"
              echo "Listing contents of rom_extracted/IMAGES for debugging:"
              ls -lh rom_extracted/IMAGES/ || true
              exit 1
          fi

          echo "‚úÖ Process Finished Successfully!"
