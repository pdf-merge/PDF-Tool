name: test-zz

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Select device code OR Select Custom'
        required: true
        default: 'PKG110'
        type: choice 
        options:
          - PLK110
          - PLQ110
          - PJZ110
          - PKX110
          - PKG110
          - PKR110
          - PLF110
          - PLC110
          - PJE110
          - PJX110
          - PJF110
          - PJD110
          - OPD2413
          - OPD2404
          - RMX6699
          - RMX5200
          - RMX5010
          - RMX5090
          - RMX6688
          - RMX3800
          - RMX3888
          - RMX5060
          - RMX5062
          - RMX5080
          - RMX5071
          - PKT110
          - PKC110
          - PKB110
          - PLB110
          - PHY110
          - Custom
      
      CUSTOM_URL:
        description: 'Custom (If selected above)'
        required: false
        default: ''

env:
  TZ: Asia/Ho_Chi_Minh

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    steps:
      - name: Clean 1
        run: |
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
          sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo apt -y autoremove --purge || true
          sudo apt -y autoclean || true
          sudo apt clean || true
      
      - name: Clean 2
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 1024
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
      
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install System & Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo apt-get install -y --no-install-recommends \
            aria2 rclone zip unzip p7zip-full python3-pip \
            liblz4-tool zstd xmlstarlet bc file git \
            build-essential autoconf libtool pkg-config uuid-dev liblz4-dev libselinux1-dev \
            zlib1g-dev \
            android-sdk-libsparse-utils
            
      - name: Process Super Domestic
        env:
            RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          
          mkdir -p tmp
          export TMPDIR=$(pwd)/tmp
          
          echo "üîß Setting up Rclone config..."
          echo "$RCLONE_CONF" > rclone.conf
          
          echo "üëÄ Listing available remotes in config:"
          rclone --config rclone.conf listremotes
          echo "-----------------------------------"
          
          OPTION="${{ github.event.inputs.ROM_URL }}"
          CUSTOM="${{ github.event.inputs.CUSTOM_URL }}"
          
          if [ "$OPTION" == "Custom" ]; then
            if [ -z "$CUSTOM" ]; then
              echo "‚ùå Error: Custom selected but empty URL!"
              exit 1
            fi
            INPUT="$CUSTOM"
          else
            INPUT="$OPTION"
          fi

          echo "üéØ Target: $INPUT"

          echo "üîç Searching in OneDrive: Mirror/Domestic..."
          FILE="$(rclone --config rclone.conf lsf '1drive:/Mirror/Domestic' --files-only --include "${INPUT}*" | head -n1)"
          
          if [ -n "$FILE" ]; then
            echo "‚úÖ Found in OneDrive Domestic: $FILE"
            SOURCE_PATH="1drive:/Mirror/Domestic"
          else
            echo "‚ùå Error: File not found in Mirror/Domestic (1drive)!"
            exit 1
          fi

          echo "üîó Generating Direct Link..."
          DIRECT_URL=$(rclone --config rclone.conf link "$SOURCE_PATH/$FILE")
          
          if [ -n "$DIRECT_URL" ]; then
             echo "::add-mask::$DIRECT_URL"
             echo "üåê Link generated: $DIRECT_URL"
             
             echo "‚¨áÔ∏è Downloading $FILE with aria2..."
             aria2c -x16 -s16 -k1M --check-certificate=false -o "$FILE" "$DIRECT_URL"
          else
             echo "‚ùå Error: Could not generate direct link. Falling back to rclone copy..."
             rclone --config rclone.conf copy "$SOURCE_PATH/$FILE" . --transfers=8 --checkers=16 --progress
          fi

          echo "üì¶ Unzipping ROM..."
          mkdir -p rom_extracted
          unzip -q "$FILE" -d rom_extracted
          rm "$FILE"

          echo "üïµÔ∏è Detecting folder structure..."
          DETECTED_PATH=$(find rom_extracted -name "IMAGES" -type d | head -n 1)
          
          if [ -n "$DETECTED_PATH" ]; then
            REAL_ROOT=$(dirname "$DETECTED_PATH")
            
            if [ "$REAL_ROOT" != "rom_extracted" ]; then
              echo "‚ö†Ô∏è Nested structure detected at: $REAL_ROOT"
              echo "üîÑ Moving files to root (rom_extracted)..."
              
              mv "$REAL_ROOT"/* rom_extracted/
              
              rmdir "$REAL_ROOT" 2>/dev/null || true
            else
              echo "‚úÖ Structure is already flat."
            fi
          fi

          echo "üìÇ Checking structure..."
          if [ -d "rom_extracted/IMAGES" ] && [ -d "rom_extracted/SYSTEM" ] && [ -d "rom_extracted/RADIO" ]; then
              echo "‚úÖ Valid Structure: IMAGES, SYSTEM, RADIO found."
          else
              echo "‚ö†Ô∏è Warning: Standard folders missing. Listing content:"
              ls -F rom_extracted/
          fi

          echo "‚¨áÔ∏è Cloning build-super-domestic (Private Repo)..."
          git clone https://${{ secrets.ACTION_TOKEN }}@github.com/proplayer1131/build-super-domestic tools_repo

          echo "üõ†Ô∏è Merging tool into extracted ROM..."
          cp -rf tools_repo/* rom_extracted/
          rm -rf rom_extracted/.git

          echo "üîë Granting execute permissions..."
          sudo chmod -R 777 rom_extracted/
          
          echo "‚öôÔ∏è Running create_super_img.sh..."
          cd rom_extracted
          
          if [ -f "create_super_img.sh" ]; then
            sudo ./create_super_img.sh
          else
            echo "‚ùå Error: create_super_img.sh not found inside rom_extracted!"
            ls -F
            exit 1
          fi
          
          cd ..

          TARGET_IMG="rom_extracted/IMAGES/super.img"
          
          DIR_NAME="${FILE%.*}" 
          DEST_PATH="1drive:/Mirror/Domestic/Super/$DIR_NAME"
          
          echo "üöÄ Checking for output file: $TARGET_IMG"
          
          if [ -f "$TARGET_IMG" ]; then
              echo "‚úÖ File found! Uploading ONLY super.img..."
              echo "‚û°Ô∏è Destination: $DEST_PATH/super.img"
              
              rclone --config rclone.conf copy "$TARGET_IMG" "$DEST_PATH" \
                --transfers=8 --checkers=16 --progress
          else
              echo "‚ùå Error: super.img NOT found at $TARGET_IMG"
              echo "Listing contents of rom_extracted/IMAGES for debugging:"
              ls -lh rom_extracted/IMAGES/ || true
              exit 1
          fi

          echo "‚úÖ Process Finished Successfully!"
