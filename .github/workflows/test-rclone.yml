name: test-rclone

on:
  workflow_dispatch:
    inputs:
      source_path:
        description: 'Source GDrive Path (gdrive1:)'
        required: true
        default: 'TenThuMucGoc'
      destination_path:
        description: 'Destination OneDrive Path (1drive:)'
        required: true
        default: 'Mirror'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Clean 1 (Free up space)
        run: |
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
          sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo apt -y autoremove --purge || true
          sudo apt -y autoclean || true
          sudo apt clean || true

      - name: Clean 2 (Maximize Build Space)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          
      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone
        env:
          RCLONE_CONFIG_BASE64: ${{ secrets.RCLONE_CONF_BASE64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo $RCLONE_CONFIG_BASE64 | base64 --decode > ~/.config/rclone/rclone.conf
          
      - name: Send Start Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸš€ Starting Sync...
            Source (GDrive): gdrive1:${{ github.event.inputs.source_path }}
            Destination (OneDrive): 1drive:${{ github.event.inputs.destination_path }}

      - name: Run Rclone Sync
        run: |
          rclone copy "gdrive1:${{ github.event.inputs.source_path }}" "1drive:${{ github.event.inputs.destination_path }}" \
            --verbose \
            --transfers 10 \
            --stats 30s \
            --stats-one-line \
            > rclone_log.txt 2>&1 || true

      - name: Prepare Summary
        run: |
          echo "âœ… Sync Completed!" > summary.txt
          echo "Source: gdrive1:${{ github.event.inputs.source_path }}" >> summary.txt
          echo "Destination: 1drive:${{ github.event.inputs.destination_path }}" >> summary.txt
          echo "---" >> summary.txt
          echo "Last 20 lines from log summary:" >> summary.txt
          tail -n 20 rclone_log.txt >> summary.txt

      - name: Send Finish Notification & Log
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message_file: "summary.txt"

