name: Build Super Domestic

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Select device code OR Select Custom'
        required: true
        default: 'PKG110'
        type: choice 
        options:
          - PLK110
          - PLQ110
          - PJZ110
          - PKX110
          - PKG110
          - PKR110
          - PLF110
          - PLC110
          - PJE110
          - PJX110
          - PJF110
          - PJD110
          - OPD2413
          - OPD2404
          - RMX6699
          - RMX5200
          - RMX5010
          - RMX5090
          - RMX6688
          - RMX3800
          - RMX3888
          - RMX5060
          - RMX5062
          - RMX5080
          - RMX5071
          - PKT110
          - PKC110
          - PKB110
          - PLB110
          - PHY110
          - Custom
      
      CUSTOM_URL:
        description: 'Custom (If selected above)'
        required: false
        default: ''

env:
  TZ: Asia/Ho_Chi_Minh

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    steps:
      # --- PH·∫¶N CLEAN ---
      - name: Clean 1
        run: |
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d || true
          sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo apt -y autoremove --purge || true
          sudo apt -y autoclean || true
          sudo apt clean || true
      
      - name: Clean 2
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 1024
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
      
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # --- PH·∫¶N C√ÄI ƒê·∫∂T DEPENDENCIES ---
      - name: Install System & Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo apt-get install -y --no-install-recommends \
            aria2 rclone zip unzip p7zip-full python3-pip \
            liblz4-tool zstd xmlstarlet bc file git \
            build-essential autoconf libtool pkg-config uuid-dev liblz4-dev libselinux1-dev \
            zlib1g-dev \
            android-sdk-libsparse-utils
            
      # --- SETUP RCLONE ---
      - name: Set up Rclone Tool
        run: |
          mkdir -p bin
          aria2c -x 16 -s 16 -j 1 -o bin/rclone1 https://github.com/buihien224/toolbox_notification/releases/download/rclone/rclone1
          chmod +x bin/rclone1
          wget -O bin/lsc.conf https://github.com/buihien224/toolbox_notification/releases/download/rclone/lsc.conf || touch bin/lsc.conf

      # --- LOGIC CH√çNH ---
      - name: Process Super Domestic
        run: |
          set -e
          
          # 1. X√ÅC ƒê·ªäNH T√äN ROM
          OPTION="${{ github.event.inputs.ROM_URL }}"
          CUSTOM="${{ github.event.inputs.CUSTOM_URL }}"
          
          if [ "$OPTION" == "Custom" ]; then
            if [ -z "$CUSTOM" ]; then
              echo "‚ùå Error: Custom selected but empty URL!"
              exit 1
            fi
            INPUT="$CUSTOM"
          else
            INPUT="$OPTION"
          fi

          echo "üéØ Target: $INPUT"

          # 2. T√åM KI·∫æM TRONG MIRROR/DOMESTIC
          echo "üîç Searching in OneDrive: Mirror/Domestic..."
          FILE="$(./bin/rclone1 --config bin/lsc.conf lsf '1drive1:/Mirror/Domestic' --files-only --include "${INPUT}*" | head -n1)"
          
          if [ -n "$FILE" ]; then
            echo "‚úÖ Found in OneDrive Domestic: $FILE"
            SOURCE_PATH="1drive1:/Mirror/Domestic"
          else
            echo "‚ö†Ô∏è Not found in Domestic. Checking GDrive..."
            FILE="$(./bin/rclone1 --config bin/lsc.conf lsf 'gdrive1:/VS_Stock' --files-only --include "${INPUT}*" | head -n1)"
            if [ -n "$FILE" ]; then
                SOURCE_PATH="gdrive1:/VS_Stock"
                echo "‚úÖ Found in GDrive backup: $FILE"
            else
                echo "‚ùå Error: File not found in Mirror/Domestic or GDrive!"
                exit 1
            fi
          fi

          # 3. T·∫¢I FILE V·ªÄ
          echo "‚¨áÔ∏è Downloading $FILE..."
          ./bin/rclone1 --config bin/lsc.conf copy "$SOURCE_PATH/$FILE" . \
            --transfers=8 --checkers=16 --progress

          # 4. GI·∫¢I N√âN
          echo "üì¶ Unzipping ROM..."
          mkdir -p rom_extracted
          unzip -q "$FILE" -d rom_extracted
          rm "$FILE" # X√≥a file zip cho nh·∫π

          # 5. KI·ªÇM TRA C·∫§U TR√öC
          echo "üìÇ Checking structure..."
          if [ -d "rom_extracted/IMAGES" ] && [ -d "rom_extracted/SYSTEM" ] && [ -d "rom_extracted/RADIO" ]; then
              echo "‚úÖ Valid Structure: IMAGES, SYSTEM, RADIO found."
          else
              echo "‚ö†Ô∏è Warning: Standard folders missing. Listing content:"
              ls -F rom_extracted/
          fi

          # 6. T·∫¢I REPO SUPER DOMESTIC
          echo "‚¨áÔ∏è Cloning build-super-domestic..."
          git clone https://github.com/proplayer1131/build-super-domestic tools_repo

          # 7. MERGE TOOL V√ÄO ROM
          echo "üõ†Ô∏è Merging tool into extracted ROM..."
          cp -rf tools_repo/* rom_extracted/
          rm -rf rom_extracted/.git
          
          # 8. CH·∫†Y SCRIPT T·∫†O SUPER IMAGE
          echo "‚öôÔ∏è Running create_super_img.sh..."
          cd rom_extracted
          
          if [ -f "create_super_img.sh" ]; then
            sudo chmod +x create_super_img.sh
            sudo ./create_super_img.sh
          else
            echo "‚ùå Error: create_super_img.sh not found inside rom_extracted!"
            ls -F
            exit 1
          fi
          
          cd .. # Quay l·∫°i th∆∞ m·ª•c g·ªëc

          # 9. UPLOAD FILE SUPER.IMG
          # ƒê∆∞·ªùng d·∫´n file img t·∫°o ra (theo script b·∫°n cung c·∫•p l√† n·∫±m trong th∆∞ m·ª•c IMAGES)
          TARGET_IMG="rom_extracted/IMAGES/super.img"
          
          # T√™n th∆∞ m·ª•c tr√™n cloud (b·ªè ƒëu√¥i .zip)
          DIR_NAME="${FILE%.*}" 
          DEST_PATH="1drive1:/Mirror/Domestic/Super/$DIR_NAME"
          
          echo "üöÄ Checking for output file: $TARGET_IMG"
          
          if [ -f "$TARGET_IMG" ]; then
              echo "‚úÖ File found! Uploading ONLY super.img..."
              echo "‚û°Ô∏è Destination: $DEST_PATH/super.img"
              
              # Upload file c·ª• th·ªÉ thay v√¨ c·∫£ th∆∞ m·ª•c
              ./bin/rclone1 --config bin/lsc.conf copy "$TARGET_IMG" "$DEST_PATH" \
                --transfers=8 --checkers=16 --progress
          else
              echo "‚ùå Error: super.img NOT found at $TARGET_IMG"
              echo "Listing contents of rom_extracted/IMAGES for debugging:"
              ls -lh rom_extracted/IMAGES/ || true
              exit 1
          fi

          echo "‚úÖ Process Finished Successfully!"
